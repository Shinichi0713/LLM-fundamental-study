<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>1&period; &#x5b9f;&#x9a13;&#x8a2d;&#x8a08;&#x65b9;&#x91dd;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}
nav {
    background-color: #f8f9fa;
    border: 1px solid #e1e4e8;
    border-radius: 12px;
    padding: 24px;
    margin: 20px 0 40px 0;
    max-width: 600px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.05);
}

/* ã€Œç›®æ¬¡ã€ã¨ã„ã†ã‚¿ã‚¤ãƒˆãƒ« */
nav h3 {
    margin-top: 0;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 2px solid #0969da;
    color: #24292f;
    font-size: 1.2rem;
    display: flex;
    align-items: center;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã®å‰ã«ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆçµµæ–‡å­—ï¼‰ã‚’è¿½åŠ  */
nav h3::before {
    content: "ğŸ“–";
    margin-right: 8px;
}

/* ãƒªã‚¹ãƒˆã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
#toc {
    list-style: none;
    padding-left: 0;
    margin: 0;
}

#toc li {
    margin-bottom: 8px;
    line-height: 1.4;
}

/* ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#toc a {
    color: #0969da;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s ease;
    display: inline-block;
}

#toc a:hover {
    color: #cf222e;
    transform: translateX(5px); /* ãƒ›ãƒãƒ¼æ™‚ã«å°‘ã—å³ã«å‹•ã */
}

/* h3ï¼ˆå°è¦‹å‡ºã—ï¼‰ãŒã‚ã‚‹å ´åˆã®ãƒã‚¹ãƒˆè¡¨ç¾ï¼ˆJSã®ä¿®æ­£ã‚‚å¿…è¦ï¼‰ */
.toc-h3 {
    padding-left: 20px;
    font-size: 0.9em;
    opacity: 0.8;
}
</style>
        
        </head>
        <body class="vscode-body vscode-light">
<nav>
        <h3>ç›®æ¬¡</h3>
        <ul id="toc"></ul> 
</nav>
            <p>ä»Šå›ã¯MoEã«ã¤ã„ã¦æœ‰ç„¡ã«ã‚ˆã‚‹æ€§èƒ½ã®å·®ã‚’ãªã‚“ã¨ã‹çŸ¥ã‚‹ã“ã¨ãŒå‡ºæ¥ãªã„ã‹ã¨è€ƒãˆã¾ã—ãŸã€‚</p>
<p>ä»¥ä¸‹ã®å®Ÿé¨“ã§æ€§èƒ½ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚</p>
<h2 id="1-å®Ÿé¨“è¨­è¨ˆæ–¹é‡">1. å®Ÿé¨“è¨­è¨ˆæ–¹é‡</h2>
<p>å®Ÿé¨“ã‚’å§‹ã‚ã‚‹å‰ã«MoEã®å„ªä½æ€§ãŒå‡ºã‚‹æ¡ä»¶ã«ã¤ã„ã¦æ•´ç†ã—ã¾ã™ã€‚</p>
<ol>
<li>
<p><strong>å…¥åŠ›åˆ†å¸ƒãŒæ˜ç¢ºã«å¤šå³°æ€§ï¼ˆheterogeneousï¼‰</strong></p>
</li>
<li>
<p><strong>ã‚µãƒ–ã‚¿ã‚¹ã‚¯é–“ã§å¿…è¦ãªå†…éƒ¨è¡¨ç¾ãƒ»æ¨è«–æ§˜å¼ãŒå¤§ããç•°ãªã‚‹</strong></p>
</li>
<li>
<p><strong>1ã‚µãƒ³ãƒ—ãƒ«ã‚ãŸã‚Šã§ã¯å˜ç´”ã ãŒã€å…¨ä½“ã¨ã—ã¦ã¯æ··åœ¨ã—ã¦ã„ã‚‹</strong></p>
</li>
<li>
<p>Denseãƒ¢ãƒ‡ãƒ«ã§ã¯</p>
<ul>
<li>ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å…±æœ‰ã«ã‚ˆã‚‹<strong>è¡¨ç¾å¹²æ¸‰ï¼ˆinterferenceï¼‰</strong></li>
<li>å®¹é‡ä¸è¶³ or å‹¾é…ç«¶åˆ
ãŒç™ºç”Ÿã™ã‚‹</li>
</ul>
</li>
</ol>
<p>â†’ MoEã¯ã€Œ<strong>æ¡ä»¶ä»˜ãè¨ˆç®—ï¼‹å°‚é–€åŒ–</strong>ã€ã«ã‚ˆã£ã¦ã“ã‚Œã‚’å›é¿ã§ãã¾ã™ã€‚</p>
<p>ã¨ã„ã†ã“ã¨ã§å•é¡Œã®ç¯„å›²ã‚’å¤šæ§˜ã«ã—ã¦é€šå¸¸ã®Denseãƒ¢ãƒ‡ãƒ«ã¨ã®æ€§èƒ½å·®ã‚’ç¢ºèªã—ã¦ã„ã“ã†ã¨æ€ã„ã¾ã™ã€‚</p>
<h2 id="2-ä¾‹é¡Œæ¨è«–æ§˜å¼ãŒç•°ãªã‚‹æ•°ç†è«–ç†è¨€èªæ··åœ¨qa">2. ä¾‹é¡Œâ‘ ï¼šæ¨è«–æ§˜å¼ãŒç•°ãªã‚‹æ•°ç†ãƒ»è«–ç†ãƒ»è¨€èªæ··åœ¨QA</h2>
<p>æ¬¡ã«ãƒ¢ãƒ‡ãƒ«ã«è§£ã‹ã›ã‚‹å•é¡Œã‚’è€ƒãˆã¾ã™ã€‚</p>
<h3 id="å•é¡Œè¨­å®š">å•é¡Œè¨­å®š</h3>
<p>ä»¥ä¸‹ã®4ã‚¿ã‚¤ãƒ—ã®å•é¡ŒãŒ<strong>ãƒ©ãƒ³ãƒ€ãƒ ã«æ··åœ¨</strong>ã—ã¦å‡ºé¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
ã“ã‚Œã§ãƒ¢ãƒ‡ãƒ«ã«ã¨ã£ã¦ã¯ç•°ãªã‚‹å•é¡ŒãŒå‡ºé¡Œã•ã‚Œã‚‹ã¨ã„ã†çŠ¶æ³ã‚’ä½œã‚Šå‡ºã—ã¾ã™ã€‚</p>
<table>
<thead>
<tr>
<th>ã‚¿ã‚¤ãƒ—</th>
<th>å†…å®¹</th>
<th>å¿…è¦èƒ½åŠ›</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>é€æ¬¡çš„ãªæ•°å€¤è¨ˆç®—</td>
<td>ç®—è¡“ãƒ»çŠ¶æ…‹æ›´æ–°</td>
</tr>
<tr>
<td>B</td>
<td>è«–ç†ãƒ‘ã‚ºãƒ«</td>
<td>è¨˜å·æ¨è«–</td>
</tr>
<tr>
<td>C</td>
<td>ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç†è§£</td>
<td>æ§‹æ–‡ãƒ»åˆ¶å¾¡ãƒ•ãƒ­ãƒ¼</td>
</tr>
<tr>
<td>D</td>
<td>è‡ªç„¶è¨€èªèª­è§£</td>
<td>æ„å‘³è¡¨ç¾</td>
</tr>
</tbody>
</table>
<h3 id="ã‚µãƒ³ãƒ—ãƒ«å•é¡Œ">ã‚µãƒ³ãƒ—ãƒ«å•é¡Œ</h3>
<h4 id="a-æ•°å€¤çŠ¶æ…‹æ¨è«–">A: æ•°å€¤çŠ¶æ…‹æ¨è«–</h4>
<pre><code>x=3ã‹ã‚‰é–‹å§‹ã™ã‚‹ã€‚
ä»¥ä¸‹ã‚’é †ã«å®Ÿè¡Œã›ã‚ˆã€‚
1. xã‚’2å€ã™ã‚‹
2. xã«5ã‚’è¶³ã™
3. xã‚’3ã§å‰²ã£ãŸä½™ã‚Šã‚’æ±‚ã‚ã‚‹
æœ€çµ‚çµæœã¯ï¼Ÿ
</code></pre>
<h4 id="b-è«–ç†æ¨è«–">B: è«–ç†æ¨è«–</h4>
<pre><code>Aã¯Bã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚
Cã¯Aã‚ˆã‚ŠèƒŒãŒä½ã„ã€‚
Dã¯Bã‚ˆã‚ŠèƒŒãŒé«˜ã„ã€‚
æœ€ã‚‚èƒŒãŒé«˜ã„å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã¯èª°ã‹ï¼Ÿ
</code></pre>
<h4 id="c-ã‚³ãƒ¼ãƒ‰ç†è§£">C: ã‚³ãƒ¼ãƒ‰ç†è§£</h4>
<pre><code class="language-python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">f</span>(<span class="hljs-params">x</span>):
    y = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(x):
        <span class="hljs-keyword">if</span> i % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:
            y += i
    <span class="hljs-keyword">return</span> y

f(<span class="hljs-number">6</span>)ã®æˆ»ã‚Šå€¤ã¯ï¼Ÿ
</code></pre>
<h4 id="d-è¨€èªèª­è§£">D: è¨€èªèª­è§£</h4>
<pre><code>å¤ªéƒã¯èŠ±å­ã‚ˆã‚Šå¹´ä¸Šã§ã‚ã‚‹ã€‚
èŠ±å­ã¯æ¬¡éƒã‚ˆã‚Šå¹´ä¸‹ã§ã‚ã‚‹ã€‚
ã“ã®æƒ…å ±ã‹ã‚‰å¿…ãšè¨€ãˆã‚‹ã“ã¨ã¯ä½•ã‹ï¼Ÿ
</code></pre>
<h3 id="ãªãœmoeãŒæœ‰åˆ©ã‹">ãªãœMoEãŒæœ‰åˆ©ã‹</h3>
<ul>
<li>
<p><strong>Denseãƒ¢ãƒ‡ãƒ«</strong></p>
<ul>
<li>1ã¤ã®å†…éƒ¨è¡¨ç¾ã§
æ•°å€¤è¨ˆç®— / è«–ç† / æ§‹æ–‡ / æ„å‘³
ã‚’ã™ã¹ã¦å‡¦ç† â†’ å‹¾é…å¹²æ¸‰</li>
</ul>
</li>
<li>
<p><strong>MoEãƒ¢ãƒ‡ãƒ«</strong></p>
<ul>
<li>Expert 1: ç®—è¡“ãƒ»çŠ¶æ…‹é·ç§»</li>
<li>Expert 2: è«–ç†é–¢ä¿‚</li>
<li>Expert 3: ã‚³ãƒ¼ãƒ‰ãƒ»åˆ¶å¾¡æ§‹é€ </li>
<li>Expert 4: è¨€èªæ„å‘³</li>
<li>RouterãŒå…¥åŠ›ç‰¹å¾´ï¼ˆtokenåˆ†å¸ƒãƒ»æ§‹æ–‡ï¼‰ã§åˆ†å²</li>
</ul>
</li>
</ul>
<p>MoEãƒ¢ãƒ‡ãƒ«ã¯å•é¡Œã«ã‚ˆã£ã¦å¯¾å¿œã‚’å¤‰ãˆã‚‹ã“ã¨ã§çŠ¶æ³ã«å¿œã˜ãŸå›ç­”åŠ›ãŒã¤ãã¨æœŸå¾…ã•ã‚Œã¾ã™ã€‚
çµæœã€<strong>å…¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æ•°ã‚’æƒãˆã¦ã‚‚ã€MoEã®æ–¹ãŒæ­£ç­”ç‡ãŒé«˜ããªã‚‹</strong>ã®ã§ã¯ã¨æƒ³å®šã•ã‚Œã¾ã™ã€‚</p>
<h2 id="3-ä¾‹é¡Œã‚¿ã‚¹ã‚¯åˆ‡æ›¿ã‚’ä¼´ã†é€æ¬¡å…¥åŠ›moeãŒæœ€ã‚‚å·®ã‚’å‡ºã—ã‚„ã™ã„">3. ä¾‹é¡Œâ‘¡ï¼šã‚¿ã‚¹ã‚¯åˆ‡æ›¿ã‚’ä¼´ã†é€æ¬¡å…¥åŠ›ï¼ˆMoEãŒæœ€ã‚‚å·®ã‚’å‡ºã—ã‚„ã™ã„ï¼‰</h2>
<h3 id="å•é¡Œè¨­å®š-1">å•é¡Œè¨­å®š</h3>
<p>1ã¤ã®å…¥åŠ›ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å†…ã§<strong>ã‚¿ã‚¹ã‚¯ãŒåˆ‡ã‚Šæ›¿ã‚ã‚‹</strong>ã€‚</p>
<pre><code>Q1: 17 + 24 ã¯ã„ãã¤ã‹ï¼Ÿ
Q2: ä»¥ä¸‹ã®æ–‡ã®è«–ç†çš„èª¤ã‚Šã‚’æŒ‡æ‘˜ã›ã‚ˆã€‚
ã€Œã™ã¹ã¦ã®é³¥ã¯é£›ã¹ã‚‹ã€‚ãƒšãƒ³ã‚®ãƒ³ã¯é³¥ã§ã‚ã‚‹ã€‚ã‚ˆã£ã¦ãƒšãƒ³ã‚®ãƒ³ã¯é£›ã¹ã‚‹ã€‚ã€
Q3: æ¬¡ã®ã‚³ãƒ¼ãƒ‰ã®å‡ºåŠ›ã¯ï¼Ÿ
print(sum([i for i in range(10) if i%3==0]))
</code></pre>
<h3 id="è©•ä¾¡æ–¹æ³•">è©•ä¾¡æ–¹æ³•</h3>
<ul>
<li><strong>å…¨å•æ­£è§£ç‡</strong></li>
<li><strong>å¾ŒåŠå•é¡Œã§ã®ç²¾åº¦åŠ£åŒ–</strong></li>
</ul>
<h2 id="4-å®Ÿé¨“ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…">4. å®Ÿé¨“ã‚³ãƒ¼ãƒ‰ã®å®Ÿè£…</h2>
<p>ã“ã“ã¾ã§è€ƒãˆãŸæ§‹æˆã§å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
ãƒ¢ãƒ‡ãƒ«ã®ãƒ©ãƒƒãƒ‘ãƒ¼ã¨ã—ã¦pytorch_lightningã€è©•ä¾¡ã¯tensor boardã‚’ä½¿ã„ã¾ã™ã€‚</p>
<pre><code class="language-python"><span class="hljs-keyword">import</span> random
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">from</span> torch.utils.data <span class="hljs-keyword">import</span> Dataset, DataLoader
<span class="hljs-keyword">import</span> torch.nn <span class="hljs-keyword">as</span> nn
<span class="hljs-keyword">import</span> torch.nn.functional <span class="hljs-keyword">as</span> F
<span class="hljs-keyword">import</span> pytorch_lightning <span class="hljs-keyword">as</span> pl
<span class="hljs-keyword">from</span> pytorch_lightning.loggers <span class="hljs-keyword">import</span> TensorBoardLogger

TASKS = [<span class="hljs-string">&quot;arith&quot;</span>, <span class="hljs-string">&quot;logic&quot;</span>, <span class="hljs-string">&quot;code&quot;</span>, <span class="hljs-string">&quot;nl&quot;</span>]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleTokenizer</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self</span>):
        chars = <span class="hljs-built_in">list</span>(<span class="hljs-string">&quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789+=?., &quot;</span>)
        self.pad_token = <span class="hljs-string">&quot;&lt;pad&gt;&quot;</span>
        self.unk_token = <span class="hljs-string">&quot;&lt;unk&gt;&quot;</span>

        self.vocab = [self.pad_token, self.unk_token] + chars
        self.stoi = {c: i <span class="hljs-keyword">for</span> i, c <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(self.vocab)}
        self.itos = {i: c <span class="hljs-keyword">for</span> c, i <span class="hljs-keyword">in</span> self.stoi.items()}

<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">vocab_size</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(self.vocab)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">encode</span>(<span class="hljs-params">self, text, max_len</span>):
        ids = [self.stoi.get(c, self.stoi[self.unk_token]) <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> text]
        ids = ids[:max_len]
        pad_len = max_len - <span class="hljs-built_in">len</span>(ids)
        ids += [self.stoi[self.pad_token]] * pad_len
        <span class="hljs-keyword">return</span> ids

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">decode</span>(<span class="hljs-params">self, ids</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&quot;</span>.join(self.itos[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> ids <span class="hljs-keyword">if</span> i != self.stoi[self.pad_token])


<span class="hljs-keyword">class</span> <span class="hljs-title class_">MixedTaskDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, n_samples=<span class="hljs-number">10000</span>, vocab=<span class="hljs-literal">None</span>, max_len=<span class="hljs-number">64</span></span>):
        self.n = n_samples
        self.vocab = vocab
        self.max_len = max_len

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self.n

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_arith</span>(<span class="hljs-params">self</span>):
        x = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
        y = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>)
        q = <span class="hljs-string">f&quot;<span class="hljs-subst">{x}</span> + <span class="hljs-subst">{y}</span> = ?&quot;</span>
        a = <span class="hljs-built_in">str</span>(x + y)
        <span class="hljs-keyword">return</span> q, a

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_logic</span>(<span class="hljs-params">self</span>):
        q = <span class="hljs-string">&quot;All A are B. C is A. Is C B?&quot;</span>
        a = <span class="hljs-string">&quot;Yes&quot;</span>
        <span class="hljs-keyword">return</span> q, a

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_code</span>(<span class="hljs-params">self</span>):
        q = <span class="hljs-string">&quot;What is sum of even numbers less than 6?&quot;</span>
        a = <span class="hljs-string">&quot;6&quot;</span>
        <span class="hljs-keyword">return</span> q, a

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_nl</span>(<span class="hljs-params">self</span>):
        q = <span class="hljs-string">&quot;Taro is older than Hanako. Who is older?&quot;</span>
        a = <span class="hljs-string">&quot;Taro&quot;</span>
        <span class="hljs-keyword">return</span> q, a

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):
        task = random.choice(TASKS)
        <span class="hljs-keyword">if</span> task == <span class="hljs-string">&quot;arith&quot;</span>:
            q, a = self._arith()
        <span class="hljs-keyword">elif</span> task == <span class="hljs-string">&quot;logic&quot;</span>:
            q, a = self._logic()
        <span class="hljs-keyword">elif</span> task == <span class="hljs-string">&quot;code&quot;</span>:
            q, a = self._code()
        <span class="hljs-keyword">else</span>:
            q, a = self._nl()

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;input&quot;</span>: q,
            <span class="hljs-string">&quot;target&quot;</span>: a,
            <span class="hljs-string">&quot;task&quot;</span>: task
        }



<span class="hljs-keyword">class</span> <span class="hljs-title class_">MoE</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_hidden, n_experts=<span class="hljs-number">4</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.n_experts = n_experts

        self.router = nn.Linear(d_model, n_experts)

        self.experts = nn.ModuleList([
            nn.Sequential(
                nn.Linear(d_model, d_hidden),
                nn.ReLU(),
                nn.Linear(d_hidden, d_model)
            )
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(n_experts)
        ])

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        B, T, D = x.shape

        logits = self.router(x)                 <span class="hljs-comment"># [B, T, E]</span>
        probs = F.softmax(logits, dim=-<span class="hljs-number">1</span>)

        expert_idx = probs.argmax(dim=-<span class="hljs-number">1</span>)       <span class="hljs-comment"># [B, T]</span>

        out = torch.zeros_like(x)

        <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(self.n_experts):
            mask = expert_idx == e
            <span class="hljs-keyword">if</span> mask.<span class="hljs-built_in">any</span>():
                out[mask] = self.experts[e](x[mask])

        <span class="hljs-keyword">return</span> out, probs, expert_idx


<span class="hljs-keyword">class</span> <span class="hljs-title class_">TransformerBlock</span>(nn.Module):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, d_model, d_hidden, use_moe=<span class="hljs-literal">False</span>, n_experts=<span class="hljs-number">4</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.use_moe = use_moe

        self.attn = nn.MultiheadAttention(
            d_model, num_heads=<span class="hljs-number">4</span>, batch_first=<span class="hljs-literal">True</span>
        )
        self.norm1 = nn.LayerNorm(d_model)
        self.norm2 = nn.LayerNorm(d_model)

        <span class="hljs-keyword">if</span> use_moe:
            self.ffn = MoE(d_model, d_hidden, n_experts)
        <span class="hljs-keyword">else</span>:
            self.ffn = <span class="hljs-literal">None</span>
            self.dense_ffn = nn.Sequential(
                nn.Linear(d_model, d_hidden),
                nn.ReLU(),
                nn.Linear(d_hidden, d_model)
            )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        attn_out, _ = self.attn(x, x, x)
        x = self.norm1(x + attn_out)

        <span class="hljs-keyword">if</span> self.use_moe:
            ffn_out, router_probs, expert_idx = self.ffn(x)
        <span class="hljs-keyword">else</span>:
            ffn_out = self.dense_ffn(x)
            router_probs, expert_idx = <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>

        x = self.norm2(x + ffn_out)
        <span class="hljs-keyword">return</span> x, router_probs, expert_idx



<span class="hljs-keyword">class</span> <span class="hljs-title class_">LitModel</span>(pl.LightningModule):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, vocab_size=<span class="hljs-number">128</span>, d_model=<span class="hljs-number">128</span>, use_moe=<span class="hljs-literal">False</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.save_hyperparameters()

        self.embed = nn.Embedding(vocab_size, d_model)
        self.block = TransformerBlock(
            d_model=d_model,
            d_hidden=<span class="hljs-number">256</span>,
            use_moe=use_moe,
            n_experts=<span class="hljs-number">4</span>
        )
        self.head = nn.Linear(d_model, vocab_size)

        <span class="hljs-comment"># â˜… expert_idx ä¿å­˜ç”¨</span>
        self.expert_idx_buffer = []

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">forward</span>(<span class="hljs-params">self, x</span>):
        x = self.embed(x)
        x, router_probs, expert_idx = self.block(x)
        logits = self.head(x[:, -<span class="hljs-number">1</span>])
        <span class="hljs-keyword">return</span> logits, router_probs, expert_idx

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">training_step</span>(<span class="hljs-params">self, batch, batch_idx</span>):
        x = batch[<span class="hljs-string">&quot;input_ids&quot;</span>]
        y = batch[<span class="hljs-string">&quot;labels&quot;</span>]

        logits, router_probs, expert_idx = self(x)
        loss = F.cross_entropy(logits, y)

        <span class="hljs-keyword">if</span> router_probs <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            entropy = -(router_probs * torch.log(router_probs + <span class="hljs-number">1e-9</span>)).<span class="hljs-built_in">sum</span>(-<span class="hljs-number">1</span>).mean()
            self.log(<span class="hljs-string">&quot;router_entropy&quot;</span>, entropy)

        self.log(<span class="hljs-string">&quot;loss&quot;</span>, loss)
        <span class="hljs-keyword">return</span> loss


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">configure_optimizers</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> torch.optim.AdamW(self.parameters(), lr=<span class="hljs-number">3e-4</span>)


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">validation_step</span>(<span class="hljs-params">self, batch, batch_idx</span>):
        x = batch[<span class="hljs-string">&quot;input_ids&quot;</span>]
        y = batch[<span class="hljs-string">&quot;labels&quot;</span>]

        logits, router_probs, expert_idx = self(x)
        loss = F.cross_entropy(logits, y)

        <span class="hljs-comment"># MoE ã®ã¨ãã®ã¿åé›†</span>
        <span class="hljs-keyword">if</span> expert_idx <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            <span class="hljs-comment"># [B, T] â†’ flatten</span>
            self.expert_idx_buffer.append(
                expert_idx.detach().flatten().cpu()
            )

        self.log(<span class="hljs-string">&quot;val_loss&quot;</span>, loss, prog_bar=<span class="hljs-literal">True</span>)


    <span class="hljs-keyword">def</span> <span class="hljs-title function_">on_validation_epoch_end</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.expert_idx_buffer) == <span class="hljs-number">0</span>:
            <span class="hljs-keyword">return</span>

        expert_idx_all = torch.cat(self.expert_idx_buffer)  <span class="hljs-comment"># [N_tokens]</span>

        <span class="hljs-comment"># TensorBoard Histogram</span>
        self.logger.experiment.add_histogram(
            tag=<span class="hljs-string">&quot;MoE/expert_idx&quot;</span>,
            values=expert_idx_all,
            global_step=self.current_epoch
        )

        <span class="hljs-comment"># ãƒãƒƒãƒ•ã‚¡ã‚¯ãƒªã‚¢</span>
        self.expert_idx_buffer.clear()

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MixedTaskDataset</span>(<span class="hljs-title class_ inherited__">Dataset</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, tokenizer, n_samples=<span class="hljs-number">10000</span>, max_len=<span class="hljs-number">64</span></span>):
        self.tokenizer = tokenizer
        self.n = n_samples
        self.max_len = max_len

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__len__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> self.n

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_arith</span>(<span class="hljs-params">self</span>):
        x = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">9</span>)
        y = random.randint(<span class="hljs-number">1</span>, <span class="hljs-number">9</span>)
        q = <span class="hljs-string">f&quot;<span class="hljs-subst">{x}</span> + <span class="hljs-subst">{y}</span> = ?&quot;</span>
        a = <span class="hljs-built_in">str</span>(x + y)
        <span class="hljs-keyword">return</span> q, a, <span class="hljs-string">&quot;arith&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_logic</span>(<span class="hljs-params">self</span>):
        q = <span class="hljs-string">&quot;All A are B. C is A. Is C B?&quot;</span>
        a = <span class="hljs-string">&quot;Yes&quot;</span>
        <span class="hljs-keyword">return</span> q, a, <span class="hljs-string">&quot;logic&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_code</span>(<span class="hljs-params">self</span>):
        q = <span class="hljs-string">&quot;What is sum of even numbers less than 6?&quot;</span>
        a = <span class="hljs-string">&quot;6&quot;</span>
        <span class="hljs-keyword">return</span> q, a, <span class="hljs-string">&quot;code&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_nl</span>(<span class="hljs-params">self</span>):
        q = <span class="hljs-string">&quot;Taro is older than Hanako. Who is older?&quot;</span>
        a = <span class="hljs-string">&quot;Taro&quot;</span>
        <span class="hljs-keyword">return</span> q, a, <span class="hljs-string">&quot;nl&quot;</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getitem__</span>(<span class="hljs-params">self, idx</span>):
        task = random.choice(TASKS)

        <span class="hljs-keyword">if</span> task == <span class="hljs-string">&quot;arith&quot;</span>:
            q, a, task = self._arith()
        <span class="hljs-keyword">elif</span> task == <span class="hljs-string">&quot;logic&quot;</span>:
            q, a, task = self._logic()
        <span class="hljs-keyword">elif</span> task == <span class="hljs-string">&quot;code&quot;</span>:
            q, a, task = self._code()
        <span class="hljs-keyword">else</span>:
            q, a, task = self._nl()

        input_ids = self.tokenizer.encode(q, self.max_len)
        label_ids = self.tokenizer.encode(a, max_len=<span class="hljs-number">8</span>)

        <span class="hljs-comment"># æ¬¡ãƒˆãƒ¼ã‚¯ãƒ³äºˆæ¸¬ã§ã¯ãªãåˆ†é¡æ‰±ã„ï¼ˆæœ€å¾Œã®1æ–‡å­—ï¼‰</span>
        label = label_ids[<span class="hljs-number">0</span>]

        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">&quot;input_ids&quot;</span>: input_ids,
            <span class="hljs-string">&quot;label&quot;</span>: label,
            <span class="hljs-string">&quot;task&quot;</span>: task
        }

<span class="hljs-keyword">def</span> <span class="hljs-title function_">collate_fn</span>(<span class="hljs-params">batch</span>):
    input_ids = torch.tensor([b[<span class="hljs-string">&quot;input_ids&quot;</span>] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> batch], dtype=torch.long)
    labels = torch.tensor([b[<span class="hljs-string">&quot;label&quot;</span>] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> batch], dtype=torch.long)
    tasks = [b[<span class="hljs-string">&quot;task&quot;</span>] <span class="hljs-keyword">for</span> b <span class="hljs-keyword">in</span> batch]

    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">&quot;input_ids&quot;</span>: input_ids,
        <span class="hljs-string">&quot;labels&quot;</span>: labels,
        <span class="hljs-string">&quot;task&quot;</span>: tasks
    }


tokenizer = SimpleTokenizer()

train_dataset = MixedTaskDataset(
    tokenizer=tokenizer,
    n_samples=<span class="hljs-number">20000</span>,
    max_len=<span class="hljs-number">64</span>
)

train_loader = DataLoader(
    train_dataset,
    batch_size=<span class="hljs-number">32</span>,
    shuffle=<span class="hljs-literal">True</span>,
    num_workers=<span class="hljs-number">4</span>,
    collate_fn=collate_fn,
    pin_memory=<span class="hljs-literal">True</span>
)

val_dataset = MixedTaskDataset(
    tokenizer=tokenizer,
    n_samples=<span class="hljs-number">2000</span>,
    max_len=<span class="hljs-number">64</span>
)

val_loader = DataLoader(
    val_dataset,
    batch_size=<span class="hljs-number">32</span>,
    shuffle=<span class="hljs-literal">False</span>,
    collate_fn=collate_fn
)

dense_model = LitModel(
    vocab_size=tokenizer.vocab_size,
    d_model=<span class="hljs-number">128</span>,
    use_moe=<span class="hljs-literal">False</span>
)
moe_model = LitModel(
    vocab_size=tokenizer.vocab_size,
    d_model=<span class="hljs-number">128</span>,
    use_moe=<span class="hljs-literal">True</span>
)

dense_logger = TensorBoardLogger(
    save_dir=<span class="hljs-string">&quot;/content/tb_logs&quot;</span>,
    name=<span class="hljs-string">&quot;dense&quot;</span>
)
moe_logger = TensorBoardLogger(
    save_dir=<span class="hljs-string">&quot;/content/tb_logs&quot;</span>,
    name=<span class="hljs-string">&quot;moe&quot;</span>
)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">make_trainer</span>(<span class="hljs-params">logger</span>):
    <span class="hljs-keyword">return</span> pl.Trainer(
        max_epochs=<span class="hljs-number">5</span>,
        accelerator=<span class="hljs-string">&quot;gpu&quot;</span>,
        devices=<span class="hljs-number">1</span>,
        logger=logger,
        log_every_n_steps=<span class="hljs-number">50</span>
    )

<span class="hljs-comment"># Dense</span>
dense_trainer = make_trainer(dense_logger)
dense_trainer.fit(dense_model, train_loader, val_loader)

<span class="hljs-comment"># MoE</span>
moe_trainer = make_trainer(moe_logger)
moe_trainer.fit(moe_model, train_loader, val_loader)
</code></pre>
<p><strong>çµæœ</strong></p>
<p>å­¦ç¿’ãƒ­ã‚¹ã¨æ¤œè¨¼ãƒ­ã‚¹ã®æ¨ç§»ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚
ç¸¦è»¸ãŒãƒ­ã‚¹å€¤ã€æ¨ªè»¸ã¯å­¦ç¿’ã®ã‚¨ãƒãƒƒã‚¯æ•°ã§ã™ã€‚</p>
<p>çµæœã€MoEã®æ–¹ãŒæ—©ãåæŸã™ã‚‹ã“ã¨ãŒç¢ºèªã•ã‚Œã¾ã—ãŸã€‚</p>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\llm\moe\doc\image\experiment_1\1766880278379.png" alt="1766880278379"></p>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\llm\moe\doc\image\experiment_1\1766880252534.png" alt="1766880252534"></p>
<p>è‚å¿ƒã®æ­£è§£ç‡ã§ã™ãŒã€‚</p>
<p>ä¸¡æ‰‹æ³•ã¨ã‚‚1.0=å…¨å•æ­£è§£ã€‚ã€‚ã€‚
å°‘ã—å•é¡ŒãŒç°¡å˜ã ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ã€‚ã€‚</p>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\llm\moe\doc\image\experiment_1\1766880421808.png" alt="1766880421808"></p>
<p>è¦‹ãŸã‹ã£ãŸå¾ŒåŠã®ç²¾åº¦åŠ£åŒ–ã‚‚ç¢ºèªã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã€‚ã€‚</p>
<p>æ¬¡å›ã¯å°‘ã—é›£ã—ã„å•é¡Œã§å®Ÿé¨“ã—ã¾ã™ã€‚</p>


<script>
const toc = document.getElementById('toc');
// h2 ã¨ h3 ã®ä¸¡æ–¹ã‚’å–å¾—
const headings = document.querySelectorAll('h2, h3');

headings.forEach((heading, i) => {
    if (!heading.id) heading.id = `heading-${i}`;
    
    const li = document.createElement('li');
    const link = document.createElement('a');
    link.href = `#${heading.id}`;
    link.textContent = heading.textContent;
    
    // h3 ã®å ´åˆã¯ã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸ã—ã¦å­—ä¸‹ã’ã™ã‚‹
    if (heading.tagName === 'H3') {
        li.classList.add('toc-h3');
    }
    
    li.appendChild(link);
    toc.appendChild(li);
});

// ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ã«ã™ã‚‹
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        document.querySelector(this.getAttribute('href')).scrollIntoView({
            behavior: 'smooth'
        });
    });
});
</script>
            
            
        </body>
        </html>