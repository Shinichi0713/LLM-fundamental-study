<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>&#x8ad6;&#x6587;&#x306e;&#x6982;&#x8981;</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-light">
            <p>本稿はLLMの論文紹介です。
RoPEは近年のLLMの位置情報を保持する機構の主流として使われている手法です。
LLMの通例として、中で行われていることは想像で、実際はどうか分からないという課題に対して解析をしたという論文です。</p>
<h2 id="論文の概要">論文の概要</h2>
<p>「<strong>Round and Round We Go! What makes Rotary Positional Encodings useful?</strong>」は、AI研究団体の <strong>EleutherAI</strong>（GPT-NeoXなどを開発したチーム）によって公開された技術記事（ブログポスト）です。</p>
<p>このタイトルは、<strong>RoPE (Rotary Positional Embeddings)</strong> の有用性を、数式と直感的なイメージを用いて深く解説したもので、現在多くのLLM開発者がRoPEを理解するための「教科書」のような存在になっています。</p>
<p>この論文（記事）の主な内容は、以下の3点に集約されます。</p>
<h3 id="1-既存の手法のいいとこ取りであることの解説">1. 既存の手法の「いいとこ取り」であることの解説</h3>
<p>この記事では、RoPEがこれまでの2つの主流な手法の課題を解決するものであることを説明しています。</p>
<ul>
<li><strong>絶対位置エンコーディング (Absolute PE)</strong>:
<ul>
<li>BERTやGPT-2で使用。計算は速いが、「相対的な関係（距離）」をモデルが直接理解するのが難しい。</li>
</ul>
</li>
<li><strong>相対位置エンコーディング (Relative PE)</strong>:
<ul>
<li>T5などで使用。「距離」を直接教えるので精度は良いが、実装が複雑で計算コストがかかる（推論時のキャッシュ効率が悪い）。</li>
</ul>
</li>
</ul>
<p><strong>RoPEの革新性</strong>:
「絶対位置の座標を与えている（計算が速い）」のに、Attentionの計算（内積）をすると「相対位置の情報しか残らない（精度が良い）」という、<strong>魔法のような性質</strong>を持っていることを示しました。</p>
<h3 id="2-回転による直感的な理解">2. 「回転」による直感的な理解</h3>
<p>タイトルにある &quot;Round and Round We Go&quot;（ぐるぐる回る）の通り、RoPEの核心が「ベクトルの回転」にあることを説明しています。</p>
<ul>
<li>単語ベクトルを2次元平面上の矢印と見なす。</li>
<li>位置が進むごとに、その矢印を少しずつ回転させる。</li>
<li><strong>重要な発見</strong>: 2つの矢印の内積（＝Attentionスコア）をとると、それぞれの絶対的な角度は相殺され、<strong>「2つの矢印の角度の差（相対距離）」だけが計算結果に残る</strong>。</li>
</ul>
<p>これにより、「なぜRoPEが相対位置を保存できるのか」を幾何学的に証明しています。</p>
<h3 id="3-長距離依存性の自然な減衰-long-term-decay">3. 長距離依存性の自然な減衰 (Long-term Decay)</h3>
<p>この記事で強調されているもう一つの重要な点は、RoPEが**「遠くの単語との関係を自然に弱める」**という特性を持っていることです。</p>
<ul>
<li>RoPEでは、高周波（速く回転する）成分と低周波（遅く回転する）成分があります。</li>
<li>距離が離れすぎると、回転の位相が激しくずれるため、内積の期待値（Attentionスコア）が小さくなります。</li>
<li>これにより、明示的にマスクしなくても、モデルは**「近くの情報を重視し、遠くの情報は参考程度にする」**という、自然言語処理にとって望ましいバイアスを自動的に獲得できると説明しています。</li>
</ul>
<h2 id="イントロ">イントロ</h2>
<p>この文章は、Transformerモデルで広く採用されている<strong>RoPE (Rotary Positional Encodings)</strong> に関する、現在の理解の課題と、その実際の挙動に関する研究の意義を述べています。</p>
<h3 id="要約ropeの有用性に関する研究課題">要約：RoPEの有用性に関する研究課題</h3>
<h4 id="1-背景と現状">1. 背景と現状</h4>
<ul>
<li><strong>位置エンコーディングの多様性</strong>: TransformerのAttention機構に位置情報（絶対位置、相対位置、バイアスなど）を与える方法はいくつかあります。</li>
<li><strong>RoPEの普及</strong>: 現在、特に<strong>LLaMA 3</strong>や<strong>Gemma</strong>などの大規模言語モデル（LLM）でRoPEが最も広く採用されています。</li>
<li><strong>RoPEのメカニズム</strong>: RoPEは、クエリとキーのベクトルを2次元のチャンクに分割し、それぞれを異なる周波数で回転させるという、効率的かつ幾何学的なアプローチです。</li>
</ul>
<h4 id="2-本研究の動機と課題">2. 本研究の動機と課題</h4>
<ul>
<li><strong>有用性の不明確さ</strong>: RoPEがこれほど広く採用されているにもかかわらず、<strong>なぜこの手法がTransformerモデルにとって有益なのか</strong>、具体的な理由やメカニズムはまだ十分に解明されていません。</li>
<li><strong>減衰特性の疑問</strong>: RoPEの提唱者（Su et al.）は、相対距離が離れるにつれてAttention係数が自然に**減衰する（Decay）**ことをRoPEの主要な利点としています。
<ul>
<li>しかし、この主張はクエリとキーが**一定（constant）**であるという前提に基づいています。</li>
<li>本研究では、実際にはこの減衰が<strong>発生しない</strong>状況が多く存在し、<strong>Gemma 7B</strong>のAttentionヘッドがこの非減衰特性を利用している場合があることを見出しました。</li>
</ul>
</li>
<li><strong>周波数の使い分けの謎</strong>: RoPEの異なる回転周波数（トークンあたり1ラジアンの高速回転から、1/10,000ラジアンの低速回転まで）が、LLM内で<strong>正確にどのように利用されているのか</strong>も未解明な、興味深い課題です。最高速の周波数は、小さな位置の変動に極めて敏感であるため、情報キャリアとしては不向きに見える、という疑問点も挙げられています。</li>
</ul>
<h2 id="ropeの減衰特性に関する要約と主張">RoPEの減衰特性に関する要約と主張</h2>
<p>この節が今回論文の主旨です。</p>
<h3 id="1-通説の問題点と本研究の主張">1. 通説の問題点と本研究の主張</h3>
<table>
<thead>
<tr>
<th style="text-align:left">項目</th>
<th style="text-align:left">通説（Su et al.）</th>
<th style="text-align:left">本研究の主張</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><strong>前提条件</strong></td>
<td style="text-align:left">クエリ (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">q</mi></mrow><annotation encoding="application/x-tex">\mathbf{q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathbf">q</span></span></span></span>) とキー (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">k</mi></mrow><annotation encoding="application/x-tex">\mathbf{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathbf">k</span></span></span></span>) は**一定（constant）**のベクトルである、という単純化された仮定に基づいて計算されている。</td>
<td style="text-align:left">この仮定は<strong>非現実的</strong>な過剰な単純化であり、無視できない。</td>
</tr>
<tr>
<td style="text-align:left"><strong>減衰の有無</strong></td>
<td style="text-align:left">既に整列したクエリとキー（aligned）間の内積は、距離と共に減衰する。</td>
<td style="text-align:left">元々整列していないクエリとキー（misaligned）の内積は、相対距離の増加と共に<strong>増加する可能性もある</strong>。</td>
</tr>
<tr>
<td style="text-align:left"><strong>意義</strong></td>
<td style="text-align:left">この減衰特性は、ベース波長(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>)の調整など、RoPEの改良の根拠として利用されてきたため、減衰しないケースを指摘することが重要である。</td>
<td style="text-align:left">RoPEは、減衰しない場合も含め、Transformerに<strong>特定な相対距離に注目するためのロバストな手段</strong>を提供している。</td>
</tr>
</tbody>
</table>
<h3 id="2-数学的根拠と実験結果">2. 数学的根拠と実験結果</h3>
<p>本研究は、2つの命題と合成実験を通じて、減衰特性が必ずしも成立しないことを示しています。</p>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\docs\image\paper_RoundandRoundWeGo!WhatmakesRotaryPositionalEncodingsuseful\1763886802683.png" alt="1763886802683"></p>
<h4 id="-命題-31-任意距離での最大化が可能">🔹 命題 3.1: 任意距離での最大化が可能</h4>
<p>RoPEは、任意のクエリ (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">q</mi></mrow><annotation encoding="application/x-tex">\mathbf{q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathbf">q</span></span></span></span>) と任意の相対距離 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> が与えられたとき、<strong>その距離 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> でSoftmax値が最大になるようなキー (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">k</mi></mrow><annotation encoding="application/x-tex">\mathbf{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathbf">k</span></span></span></span>) を見つけることが可能</strong>であることを示します。</p>
<ul>
<li><strong>意味</strong>: RoPEは、距離が離れるほどスコアが下がるという制約を持たず、モデルが<strong>任意の相対位置に強く注目する</strong>ことを許容しています。実際、<strong>Gemma 7B</strong>は、このメカニズムを利用して特定の位置に注目するヘッドを構成していることが後に示されます。</li>
</ul>
<h4 id="-命題-32-ガウス分布からのサンプリングでは減衰しない">🔹 命題 3.2: ガウス分布からのサンプリングでは減衰しない</h4>
<p>クエリ (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">q</mi></mrow><annotation encoding="application/x-tex">\mathbf{q}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6389em;vertical-align:-0.1944em;"></span><span class="mord mathbf">q</span></span></span></span>) とキー (<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="bold">k</mi></mrow><annotation encoding="application/x-tex">\mathbf{k}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathbf">k</span></span></span></span>) を標準の多変量ガウス分布 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn mathvariant="bold">0</mn><mo separator="true">,</mo><mi mathvariant="bold">I</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\mathcal{N}(\mathbf{0}, \mathbf{I})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathcal" style="margin-right:0.14736em;">N</span><span class="mopen">(</span><span class="mord mathbf">0</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">I</span><span class="mclose">)</span></span></span></span> から独立にサンプリングした場合、RoPE適用後のアクティベーションの<strong>期待値は相対距離 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi></mrow><annotation encoding="application/x-tex">r</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span></span></span></span> にかかわらず <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> になる</strong>ことを示します。</p>
<p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi mathvariant="double-struck">E</mi><mrow><mi mathvariant="bold">q</mi><mo separator="true">,</mo><mi mathvariant="bold">k</mi><mo>∼</mo><mi mathvariant="script">N</mi><mo stretchy="false">(</mo><mn mathvariant="bold">0</mn><mo separator="true">,</mo><mi mathvariant="bold">I</mi><mo stretchy="false">)</mo></mrow></msub><mo stretchy="false">[</mo><msup><mi mathvariant="bold">q</mi><mi mathvariant="normal">⊤</mi></msup><msub><mi mathvariant="bold">R</mi><mi>r</mi></msub><mi mathvariant="bold">k</mi><mo stretchy="false">]</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\mathbb{E}_{\mathbf{q},\mathbf{k} \sim \mathcal{N}(\mathbf{0}, \mathbf{I})}[\mathbf{q}^\top \mathbf{R}_r \mathbf{k}] = 0
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2543em;vertical-align:-0.3552em;"></span><span class="mord"><span class="mord mathbb">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3448em;"><span style="top:-2.5198em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathbf mtight">q</span><span class="mpunct mtight">,</span><span class="mord mathbf mtight">k</span><span class="mrel mtight">∼</span><span class="mord mathcal mtight" style="margin-right:0.14736em;">N</span><span class="mopen mtight">(</span><span class="mord mathbf mtight">0</span><span class="mpunct mtight">,</span><span class="mord mathbf mtight">I</span><span class="mclose mtight">)</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3552em;"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathbf">q</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8991em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">⊤</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathbf">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathbf">k</span><span class="mclose">]</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span></span></p>
<ul>
<li><strong>意味</strong>: 現実的なランダムなベクトル（ガウス分布）を用いた場合、理論上、<strong>相対距離によるアクティベーションの減衰傾向は存在しない</strong>ことが示されます。</li>
</ul>
<h4 id="-実験結果-図2">🔹 実験結果 (図2)</h4>
<p>合成実験の結果、以下の事実が確認されました。</p>
<ul>
<li>(a) <strong>「全てが1」の一定ベクトル</strong>を用いた場合: 通説通り、アクティベーションはある程度減衰する傾向が見られる。</li>
<li>(b) <strong>ガウス分布からサンプリングしたランダムベクトル</strong>を用いた場合: 相対距離が増加しても、アクティベーションに<strong>明確な減衰傾向は見られない</strong>。</li>
</ul>
<h3 id="主張">主張</h3>
<p>RoPEの構造を正当化するために使われてきた「減衰特性」は、単純な一定ベクトルという<strong>非現実的な前提</strong>の下でしか成立せず、より現実に近いランダムベクトル（ガウス分布）を用いた場合には成立しないことが、理論的・実験的に示されました。RoPEの真の有用性は、減衰ではなく、<strong>特定の相対距離に柔軟かつロバストに注目できる能力</strong>にあると主張されています。</p>
<p>このセクションは、Gemma 7Bモデルを分析し、<strong>RoPEの異なる回転周波数（frequencies）がAttention計算でどのように利用されているか</strong>を探求した結果を述べています。</p>
<h2 id="ropeにおける周波数の利用方法の要約">RoPEにおける周波数の利用方法の要約</h2>
<h3 id="1-研究の目的と前提">1. 研究の目的と前提</h3>
<ul>
<li><strong>問題</strong>: RoPEの周波数は、トークンあたりの変化が大きい<strong>高周波</strong>（ノイズのように振る舞う可能性がある）から、変化が非常に小さい<strong>低周波</strong>まで多岐にわたります。LLMがこれらの周波数をどのように活用しているのかは不明です。</li>
<li><strong>測定方法</strong>: コーシー＝シュワルツの不等式 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∣</mi><mo stretchy="false">⟨</mo><mi mathvariant="bold">q</mi><mo separator="true">,</mo><mi mathvariant="bold">k</mi><mo stretchy="false">⟩</mo><mi mathvariant="normal">∣</mi><mo>≤</mo><mi mathvariant="normal">∥</mi><mi mathvariant="bold">q</mi><mi mathvariant="normal">∥</mi><mi mathvariant="normal">∥</mi><mi mathvariant="bold">k</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">| \langle \mathbf{q}, \mathbf{k} \rangle | \leq \| \mathbf{q} \| \| \mathbf{k} \|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∣</span><span class="mopen">⟨</span><span class="mord mathbf">q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathbf">k</span><span class="mclose">⟩</span><span class="mord">∣</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">≤</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord mathbf">q</span><span class="mord">∥∥</span><span class="mord mathbf">k</span><span class="mord">∥</span></span></span></span> に基づき、クエリとキーの対応する周波数成分の <strong>L2ノルム（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">∥</mi><mi mathvariant="bold">k</mi><mi mathvariant="normal">∥</mi></mrow><annotation encoding="application/x-tex">\|\mathbf{k}\|</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord">∥</span><span class="mord mathbf">k</span><span class="mord">∥</span></span></span></span>)</strong> の平均を測定することで、その周波数成分がAttentionの内積に与える<strong>影響力の上限</strong>を評価しました。</li>
</ul>
<h3 id="2-gemma-7bの周波数利用パターンの発見-図3">2. Gemma 7Bの周波数利用パターンの発見 (図3)</h3>
<ul>
<li><strong>主要な発見</strong>: Gemma 7Bの全ての層（Layer）を通じて、学習は平均的に<strong>最も低い周波数</strong>に対して**最も高いノルム（norm）**を割り当てています。
<ul>
<li>これは、LLMがAttentionのアクティベーションに最も大きな影響を与えるために、最も<strong>安定している（変動が少ない）低周波成分</strong>を優先的に使用していることを示唆しています。</li>
</ul>
</li>
<li><strong>高周波の利用</strong>: 低周波が優先される一方で、<strong>最初の層と最後の層</strong>では、平均的に<strong>高周波</strong>の利用がいくらか見られました。</li>
<li><strong>RoPE固有の現象</strong>: このノルムの分布パターン（低周波への偏り）は、回転されるクエリ/キーベクトルでのみ観測され、回転されない**値ベクトル（Value vectors）**では観測されませんでした。これは、中～高周波の「チャンク」が Attention の内積計算にほとんど寄与しないと学習が判断し、そのノルムを意図的に <strong><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn></mrow><annotation encoding="application/x-tex">0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">0</span></span></span></span> に近づけている</strong>結果であると結論付けられています。</li>
</ul>
<h3 id="3-アテンションヘッドごとの分析-図4">3. アテンションヘッドごとの分析 (図4)</h3>
<ul>
<li><strong>特異なヘッド</strong>: 第1層の16個のAttentionヘッドを個別に分析したところ、<strong>ヘッド5とヘッド8</strong>が特に<strong>高周波</strong>を利用していることが分かりました。
<ul>
<li>これらのヘッドは、後のセクションで<strong>位置（Positional）に強く注目するヘッド</strong>に対応していることが示されます。</li>
</ul>
</li>
<li><strong>疎な利用パターン</strong>: ノルムが高い帯域（Band）と低い帯域が明確に分かれており、周波数利用が<strong>疎（Sparse）な性質</strong>を持つことが強調されています。
<ul>
<li>これは、フィードフォワード層が疎な辞書ルックアップテーブルとして機能するという先行研究（Geva et al., 2021）の観察と一致しており、これらの帯域が何らかの<strong>疎なクエリ/キーの意味的マッチング</strong>に使用されている可能性が指摘されています。</li>
</ul>
</li>
</ul>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\docs\image\paper_RoundandRoundWeGo!WhatmakesRotaryPositionalEncodingsuseful\1763886999225.png" alt="1763886999225"></p>
<h2 id="高周波数の利用位置特化型アテンションの要約">高周波数の利用：位置特化型アテンションの要約</h2>
<p>このセクションは、通常はモデルに敬遠される<strong>RoPEの最高周波数</strong>が、特定のAttentionヘッドでどのように利用されているか、またその意義について分析した結果を述べています。</p>
<h3 id="1-高周波数の役割と位置特化型ヘッドの発見">1. 高周波数の役割と位置特化型ヘッドの発見</h3>
<ul>
<li><strong>高周波数の特異性</strong>: RoPEの最高周波数は、その変動の激しさから、通常はGemma 7Bによってほとんど使用されない傾向があります。</li>
<li><strong>位置特化型ヘッド</strong>: 本研究では、Attentionヘッドの中には、そのアクティベーションが<strong>純粋に相対位置にのみ基づくパターン</strong>を示すものがあり、これらのヘッドは<strong>主に最高周波数</strong>を利用していることを発見しました。</li>
<li><strong>構築の可能性</strong>: RoPEは、このような**「極めてシャープな」**位置特化型アテンションパターンを、理論上、<strong>任意に構築できる</strong>ことを証明します（NoPEでは構築不可能）。Gemma 7Bは、実際にこの構造を学習しているように見えます。</li>
</ul>
<h3 id="2-gemma-7bにおける具体的なパターン-図5-6">2. Gemma 7Bにおける具体的なパターン (図5, 6)</h3>
<ul>
<li><strong>パターン例</strong>: Gemma 7Bで確認された純粋な位置特化型アテンションパターンには以下の例があります。
<ul>
<li><strong>「対角線」ヘッド (Diagonal head)</strong>: 最終層などで見られ、トークンが<strong>自分自身</strong>にのみ強く注目するパターン（残差接続のように機能する）。</li>
<li><strong>「直前トークン」ヘッド (Previous-token head)</strong>: 第1層などで見られ、トークンが<strong>直前のトークン</strong>にのみ強く注目するパターン。</li>
</ul>
</li>
<li><strong>周波数利用</strong>: 図6が示す通り、これらの位置特化型ヘッド（例：対角線ヘッド）は、他のヘッドが避ける<strong>非常に高い周波数に依存</strong>してAttentionを計算しています。この傾向は、位置特化型ヘッドを通じて一貫して見られるパターンです。</li>
<li><strong>図4との関連</strong>: 以前のセクションで高周波の利用が指摘されたヘッド5とヘッド8は、それぞれ純粋な対角線ヘッド（ヘッド5）と直前トークンヘッド（ヘッド8）に対応していました。</li>
</ul>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\docs\image\paper_RoundandRoundWeGo!WhatmakesRotaryPositionalEncodingsuseful\1763887096913.png" alt="1763887096913"></p>
<h3 id="3-結論と重要性">3. 結論と重要性</h3>
<ul>
<li><strong>RoPEの重要な能力</strong>: 最高周波数を利用して<strong>純粋な位置関係</strong>のみに注目するヘッドを構築できる能力は、<strong>自己回帰生成の最適化</strong>や、<strong>構造的な一般化</strong>（先行研究でも有用性が示唆されている）を試みる上で重要であると考えられます。</li>
<li><strong>学習された振る舞い</strong>: 対角線アテンションのように、セマンティクス（意味）を無視し、純粋に位置のみに基づくパターンをなぜLLMが学習するのかは、今後の興味深い研究課題であると述べています（一部にはトレーニング上の「バグ」である可能性も示唆）。</li>
</ul>
<h2 id="低周波数の利用セマンティックアテンションの要約">低周波数の利用：セマンティックアテンションの要約</h2>
<h3 id="1-低周波数の役割と特徴">1. 低周波数の役割と特徴</h3>
<ul>
<li><strong>優先的な利用</strong>: Gemma 7Bでは、クエリとキーの埋め込みに割り当てられるノルムの<strong>大半が低周波数</strong>に向けられています（セクション4で観察された通り）。</li>
<li><strong>セマンティクス（意味）検出</strong>: 低周波数は、<strong>トークンの相対距離による影響を最も受けにくいため</strong>、トークンの<strong>意味（セマンティクス）に関連する情報</strong>を検出するのに最も有用であると論じられています。</li>
<li><strong>不変性の限界</strong>: ただし、低周波数でも非常に長い相対距離に対しては完全に不変ではなく、最終的にはベクトルのミスアライメント（ずれ）が生じます。</li>
</ul>
<h3 id="2-コンテキスト長とベース波長の問題">2. コンテキスト長とベース波長の問題</h3>
<ul>
<li><strong>影響の最小化</strong>: 低周波数が有用なのは、<strong>相対距離による内積への影響が最も少ない</strong>周波数だからです。</li>
<li><strong>LLaMA 3の事例</strong>: <strong>LLaMA 3</strong>がベース波長 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span> を従来の10,000から<strong>500,000</strong>に増やしたことの有用性は、この点にあると考えられます。
<ul>
<li>標準の波長（10,000）では、128kトークンという長大なコンテキスト長では約2.04回転してしまい、トークンが誤ってミスアライメントされ、汎化性能が低下する可能性があります。</li>
<li>LLaMA 3の変更は、コンテキスト長が長くなるにつれて、RoPEの<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>ベース波長もそれに合わせて増加させる必要があることを示唆しています。</li>
</ul>
</li>
</ul>
<h3 id="3-セマンティック特化型ヘッドの分析図7">3. セマンティック特化型ヘッドの分析（図7）</h3>
<ul>
<li><strong>アポストロフィ検出ヘッド</strong>: 図7では、興味深い<strong>セマンティックヘッド</strong>の例が特定されています。このヘッドは、アポストロフィ（<code>’</code>）トークンの後に現れるトークンが、そのアポストロフィに注目するように動作します。
<ul>
<li><strong>例</strong>: トークン列 <code>[BOS, I, ’, m]</code> のうち、トークン <code>m</code> のアテンションはアポストロフィ <code>’</code> に向かいます。それ以外のトークンは <code>[BOS]</code> トークンに注目します。</li>
</ul>
</li>
<li><strong>周波数利用の混合</strong>: このヘッドは、意味的（アポストロフィ検出）かつ位置的（直前のトークンのみ）な性質を持ちます。
<ul>
<li><strong>高周波数</strong>: 直前のトークンに現れるアポストロフィという<strong>位置的な近接性</strong>を検出するために、<strong>高周波数</strong>が利用されていることが示されています。</li>
<li><strong>低周波数</strong>: アポストロフィがない場合に**<code>[BOS]</code> トークンにロバストに注目する**ために、<strong>低周波数</strong>の濃い帯域が使用されていると考えられています。</li>
</ul>
</li>
</ul>
<p><img src="file:///d:\PycharmProjects\LLM-research\LLM-fundamental-study\docs\image\paper_RoundandRoundWeGo!WhatmakesRotaryPositionalEncodingsuseful\1763887177426.png" alt="1763887177426"></p>
<h3 id="4-低周波数の限界">4. 低周波数の限界</h3>
<ul>
<li><strong>ロバスト性の限界</strong>: 低周波数がセマンティック情報を検出するのに役立つ一方で、非常に長いコンテキストに対しては、その「セマンティックバンド」がロバストではないことが示されています。</li>
<li><strong>理論的証明</strong>: 一つの周波数（2次元ケース）で、<strong>アテンションアクティベーションが誤って大きくなる</strong>ような相対距離が存在することを証明できるとしています。これは、長いコンテキストにおいては、この種のセマンティックバンドがロバストに機能し続けることはできないという懸念を示唆しています。</li>
</ul>
<h2 id="結論の要約ropeの挙動に関する新しい理解">結論の要約：RoPEの挙動に関する新しい理解</h2>
<p>この論文の結論は、RoPE（Rotary Positional Encodings）の挙動、特にその利点に関する通説を検証し、RoPEの各周波数帯域がLLM内で果たす役割を明確にした点にあります。</p>
<h3 id="1-通説への異議と理論的発見">1. 通説への異議と理論的発見</h3>
<ul>
<li><strong>減衰特性への反論</strong>: RoPEの利点として広く信じられてきた「相対距離が増加するにつれてAttentionウェイトが減衰する」という通説に異議を唱えました。
<ul>
<li>キーとクエリが<strong>ガウスランダムベクトル</strong>であると仮定した場合、この減衰は証明上、発生しません。</li>
<li>さらに、RoPEは、距離の大小に関わらず、<strong>任意の相対距離でAttentionウェイトが最大になる</strong>ような構造を構築できることを示しました。これらの観察結果は、RoPEを正当化する従来の直感と矛盾します。</li>
</ul>
</li>
</ul>
<h3 id="2-周波数帯域ごとの役割の解明">2. 周波数帯域ごとの役割の解明</h3>
<ul>
<li><strong>高周波数の役割（位置特化型Attention）</strong>:
<ul>
<li>高周波数帯域は、<strong>純粋な位置情報</strong>に基づくAttentionパターン（位置特化型回路）を構築するために使用されているという証拠を提示しました。</li>
<li>この振る舞いを保証する理論的な構造を提供し、Gemma 7BのAttentionヘッド内に<strong>酷似した構造</strong>が存在することを特定しました。</li>
<li>**NoPE（位置エンコーディングなし）**では同様の位置特化型Attentionを構築できないことを示し、RoPEのこの能力の重要性を強調しました。</li>
</ul>
</li>
<li><strong>低周波数の役割（意味特化型Attention）</strong>:
<ul>
<li>低周波数帯域は、主に**意味情報（セマンティック）**に基づくAttentionを検出するために使用されていることを示しました。</li>
<li>これらの低周波数からRoPEの回転を取り除くことで、<strong>意味的Attentionの能力が向上し</strong>、特に<strong>長いコンテキスト</strong>に対する汎化性能が改善する可能性があると主張しました。これはGemma 2Bを用いたアブレーション研究（一部要素を取り除いた実験）で検証されています。</li>
</ul>
</li>
</ul>
<h3 id="3-全体的な貢献">3. 全体的な貢献</h3>
<p>本研究は、RoPEの挙動について<strong>より繊細で詳細な理解</strong>を提供しました。この知見が、LLMが位置エンコーディングをどのように利用しているかについての理解を深め、特に<strong>長文コンテキスト</strong>における性能向上につながることを期待しています。</p>

            <script async src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
            
        </body>
        </html>