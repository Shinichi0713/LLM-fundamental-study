# 生成LLMの学習

近年の生成型**LLM（大規模言語モデル）**の学習は、主に**3つのステップ**を経て進められます。

この手順は、モデルに基本的な言語能力を習得させ、その後、特定のタスクや人間が望む振る舞いに合わせて性能を向上させることを目的としています。


## 1. 事前学習（Pre-training）

これは、モデルに**言語の基礎的な知識と文法、世界の一般的な情報**を教え込む最も土台となるステップです。

* **データ:** インターネット上のウェブページ、書籍、論文、ニュース記事など、**膨大で多岐にわたるテキストデータ**が使用されます。
* **学習タスク:** 主に「**次の単語予測**」が行われます。モデルは与えられたテキストの文脈から、次に来るべき最も確率の高い単語（トークン）を予測するように訓練されます。
* **結果:** このステップを通じて、モデルは言語のパターン、文法構造、そしてデータに含まれる一般的な知識を**自己教師あり学習**によって習得し、強力な**基盤モデル（Foundation Model）**となります。


## 2. 微調整（Fine-tuning）

事前学習を終えたモデルを、**特定のタスクや目的**に合わせて調整するステップです。

### 2-1. 教師あり微調整（Supervised Fine-Tuning: SFT）

* **目的:** 質問応答、要約、翻訳、指示への忠実な応答（**Instruction Following**）など、具体的なタスクの能力を高めます。
* **データ:** **高品質で、タスクに特化したラベル付きデータセット**（例：質問とそれに対する正しい応答のペア）が使われます。
* **方法:** モデルは、特定の入力に対して望ましい出力が得られるように、教師あり学習の手法でパラメーターが更新されます。

### 2-2. 人間のフィードバックによる強化学習（RLHF: Reinforcement Learning with Human Feedback）

SFTによって特定の指示に従う能力を獲得したモデルの出力を、さらに**人間がより自然で有用、かつ安全だと感じるように最適化**する、近年のLLMで重要なステップです。

このプロセスは通常、以下の3段階で構成されます。

1.  **比較データの収集:** モデルが出力した複数の回答を、**人間が「より良い」「悪い」という基準で順位付け**（ランク付け）します。
2.  **報酬モデル（Reward Model: RM）の訓練:** 人間による順位付けデータを使って、**回答の品質をスコア化する別のモデル**（報酬モデル）を訓練します。
3.  **強化学習による最適化:** 訓練された報酬モデルのスコアを「**報酬**」として使用し、元のLLM（SFTモデル）を**強化学習**で再調整します。これにより、モデルは報酬スコアが高い、つまり**人間が好む回答を生成するように学習**します。


この3つのステップを経て、LLMはただの**次単語予測マシン**から、**人間の意図を理解し、安全で有用な文章を生成できる**対話エージェントへと進化します。

# 事前学習

近年の生成型LLM（大規模言語モデル）の事前学習（Pre-training）に用いられている最も具体的な手法名とタスクは以下の通りです。

## 1. 主要な学習タスク

LLMは、**ラベル付けされていない膨大なテキストデータ**を用いて、以下の**自己教師あり学習**タスクを実行します。

| 手法名 (英語/日本語) | 概要 | 採用モデルの例 |
| :--- | :--- | :--- |
| **Next Token Prediction** / **次トークン予測** | これが**GPTシリーズ**や**Claude、LLaMA**など、**生成型**LLMの事前学習における主要なタスクです。与えられたトークン列（文の左側）に続いて最も確率の高い**次のトークン**を予測するように学習します。これにより、モデルは文章を**一貫して生成する能力**を獲得します。 | GPT-3, GPT-4, LLaMA, PaLM, Claude |
| **Masked Language Modeling (MLM)** / **マスク言語モデリング** | **BERT**のような**双方向**（文脈を理解する）モデルの事前学習に用いられた手法です。入力文の一部の単語（トークン）をマスク（隠す）し、そのマスクされたトークンを予測するように学習します。生成タスクよりも**文脈理解や抽出**に優れます。 | BERT, RoBERTa |

> 💡 **ポイント:** 近年の**生成型LLM**（例えばGPT）は、**Next Token Prediction**（次トークン予測）を主に使用し、文を一貫して生成する能力を優先して学習しています。


## 2. 基盤となるアーキテクチャ

これらの事前学習タスクを実行するために、ほぼ全ての現代的なLLMが採用している基盤技術です。

| 手法名 | 概要 |
| :--- | :--- |
| **Transformer (トランスフォーマー) 構造** | 2017年に発表され、LLMの基礎となったニューラルネットワークのアーキテクチャです。特に**自己注意機構（Self-Attention Mechanism）** 

[Image of the Transformer Architecture]
 を用いることで、文中の遠く離れた単語間の依存関係や文脈を効率的に捉えることができます。 |
| **Decoder-Only Model** | トランスフォーマーの**デコーダー部分のみ**を使用したモデル構造です。GPTシリーズやLLaMAなどが採用しており、特に**文章生成**タスクに特化しています。 |
| **Encoder-Decoder Model** | トランスフォーマーのエンコーダーとデコーダーの両方を使用したモデル構造です。翻訳や要約などの**入力と出力の構造が異なるタスク**に適しています。BARTなどが採用しています。 |
| **Rotary Positional Embedding (RoPE)** | 単語の位置情報（位置埋め込み）をモデルに組み込むための手法の一つです。従来の絶対的な位置情報（例: Sinusoidal Positional Embedding）ではなく、回転行列を用いて**相対的な位置関係**を効率的にエンベットすることで、特に長い文脈の処理能力や、モデルが学習時より長いテキストを処理する能力（外挿性）の向上に寄与します。 |


## 3. その他の重要な手法

* **大規模データセットのキュレーション (Data Curation):** 事前学習に使うテキストデータ（CommonCrawl、Wikipedia、書籍、コードなど）を収集し、**重複除去、品質フィルタリング、有害なコンテンツの削除**などの処理を大規模に行うことです。これは、モデルの性能と安全性を確保するために不可欠な工程です。
* **分散並列学習 (Distributed Parallel Training):** 非常に大規模なLLMを、数千ものGPUを使用して効率的に学習させるための技術です。**データ並列 (Data Parallelism)**や**モデル並列 (Model Parallelism)**などが組み合わせて使用されます。

# Next Token Prediction の課題

学習データに基づいて次のトークンとして**最も確率の高いもの**を正解とするため、文脈的に正しいにもかかわらず、学習データでは頻度が低い**ニュアンスが同じ異なる言い回し**を不正解としてしまうという課題があります。

この課題は、主に「モデルが生成する**多様性の欠如**」や「**単一の正解に固執する**」という形で現れます。

この課題に対応するための主な手段は、事前学習後の**微調整フェーズ**や**サンプリング戦略**によって導入されます。


## 1. 事前学習後の課題対応策（微調整フェーズ）

事前学習後、モデルに**多様な言い回し**や**人間の意図**を理解させるための重要なステップです。

### 1-1. 教師あり微調整（SFT）の質の向上

* **Instruction Tuning (指示チューニング):** モデルに多様な指示（プロンプト）と、それに対する**多様で質の高い正解応答**のペアを学習させます。このデータセットには、同じ意味でも表現が異なる複数の例を含めることで、モデルが**「意図」と「表現」の多様性**を関連付けて学習できます。
* **高品質なデータソースの利用:** 特定のドメインやニュアンスに特化した、人間が手作業で作成またはキュレーションした多様な表現を含むデータセットを使用します。

### 1-2. 人間のフィードバックによる強化学習（RLHF/DPO）

これが、**ニュアンスの課題**に対処する上で最も強力な手段です。

* **報酬モデル（Reward Model: RM）の導入:** RLHFでは、モデルが出した複数の異なる言い回しの回答を、人間が「この表現は自然で適切か」「この表現は質問の意図を正確に捉えているか」といった**ニュアンスや有用性の基準**で評価し、ランク付けします。
* **多様性の評価:** 報酬モデルは、**単に学習データと同じ表現であるか**ではなく、**人間の好む有用性や自然さ、そして質問の意図との整合性**をスコア化するように訓練されます。これにより、学習データにない、または頻度が低い表現でも、**人間にとって有用であれば高い報酬**を得て、モデルはその多様な表現を積極的に生成するようになります。


## 2. 生成時のサンプリング戦略

モデルが次のトークンを決定する際、最も確率の高いトークン以外も選択肢に入れることで、表現の多様性を意図的に高めます。

| 手法名 | 概要 | 効果 |
| :--- | :--- | :--- |
| **Temperature (温度)** | トークン選択の確率分布を**平坦化**するパラメータです。 $T$ の値を高くするほど、確率の低いトークン（つまり、学習データで頻度の低い異なる言い回し）も選ばれやすくなり、**出力の多様性**が増します。 | 表現の**ランダム性**を増やし、単調な繰り返しを防ぎます。 |
| **Top-k Sampling** | 確率の高い方から**上位 $k$ 個**のトークンに絞り、その中からランダムにサンプリングする方法です。 | 完全に無関係なトークンが選ばれるのを防ぎつつ、多様性を確保します。 |
| **Top-p (Nucleus) Sampling** | 確率の累積和が** $p$ **になるまでトークンを絞り込み、その中からサンプリングする方法です。 | 確率分布の形状に応じて柔軟に選択肢を絞り込み、Top-kよりも自然で多様な出力を生成しやすいとされます。 |

これらのサンプリング戦略を組み合わせることで、モデルは文脈的に正しい複数の選択肢の中から、より**多様で創造的な（しかし意味的に適切な）**言い回しを選び出すことができるようになります。


## まとめ

Next Token Predictionの課題を克服する鍵は、**「正解が一つである」という認識からの脱却**です。

1.  **RLHF/DPO**によって、**人間のニュアンスや意図との適合性**を報酬として学習させる。
2.  **サンプリング戦略**によって、生成時に**多様な言い回し**を積極的に探索させる。

この組み合わせにより、LLMはニュアンスが同じ異なる表現を適切に許容し、生成できるようになります。



